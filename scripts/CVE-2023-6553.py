#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Copyright (c) saucerman (https://saucer-man.com)
See the file 'LICENSE' for copying permission
"""

"""
cve-2023-6553
WordPress Backup Migration 插Backup Migration <= 1.3.7 存在RCE漏洞

漏洞原理：威胁攻击者在备份迁移插件 Backup Migration 使用的/includes/backup-heart.php 文件中的第 118 行尝试从 BMI_INCLUDES 目录（通过将 BMI_ROOT_DIR 与 includes 字符串合并定义）中加入 bypasser.php。但是，BMI_ROOT_DIR 是通过第 62 行的 content-dir HTTP 标头定义的，因此 BMI_ROOT_DIR 依旧受到用户控制。

漏洞插件源码下载地址：
- https://plugins.trac.wordpress.org/browser/backup-backup?rev=3001220
- https://plugins.trac.wordpress.org/changeset/3001220/

漏洞exp: https://github.com/Chocapikk/CVE-2023-6553

fofa: "wp-content/plugins/backup-backup"
"""

from plugin.target_parse import get_standard_url
from lib.core.Request import request
import re
from distutils.version import LooseVersion


def poc(url):
    try:
        vuln_url = f"{get_standard_url(url)}/wp-content/plugins/backup-backup/readme.txt"
        r = request.get(vuln_url)
        if r.status_code == 200:
            r1 = re.findall("Stable tag: (.*)", r.text)
            if r1:
                version_code = r1[0]
                # print(r.text)
                # print(version_code)
                # print(vuln_url)
                return LooseVersion(version_code) < LooseVersion('1.3.8')
    except:
        pass
    return False
